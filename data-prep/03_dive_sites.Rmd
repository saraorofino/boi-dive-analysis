---
title: "Dive Sites"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r libraries, include=F}
# Load libraries
library(tidyverse)
library(janitor)
library(sf)
library(glue)
library(bigrquery)
library(paletteer)
library(tigris)


# Load source
source(file.path(here::here(),"common.R"))
```


# Dive Sites

The following approach is used to try and determine dive site locations.  

  - Bin coordinates to a high resolution (0.001 degrees, ~ 111 km)  
  - Identify instances where dive vessels remain stationary in a grid cell for a minimum amount of time, testing different time thresholds from 45 minutes to 2 hours  
  - Count the number of stationary instances, "dives", in each grid cell   
  - Identify the cells with a number of "dives" above some threshold - these are the dive sites  

This method is a rough adaptation of the GFW anchorage algorithm, more details available [here](https://globalfishingwatch.org/datasets-and-code-anchorages/)  

## Bin Coordinates 

```{r sql-bin-locations}
# Keeping only coordinates where vessels moved slower than 1 knot 
sql_bin_locations <- "#StandardSQL

SELECT
  ssvid,
  date,
  lat_bin,
  lon_bin,
  SUM(hours) AS total_hours
FROM (
  SELECT
    ssvid,
    date,
    FLOOR(lat * 1000) / 1000 AS lat_bin,
    FLOOR(lon * 1000) / 1000 AS lon_bin,
    hours
  FROM
    `emlab-gcp.boi_dive_project.ci_ais_activity_2021`
  WHERE speed_knots < 1
)
GROUP BY ssvid, date, lat_bin, lon_bin"

# Run and download 
binned_locations <- bq_project_query("emlab-gcp", sql_bin_locations) %>% 
  bq_table_download(n_max = Inf)
```

## Test Thresholds

```{r test-thresholds}
# Check distribution of total time
ggplot(binned_locations, aes(x=total_hours)) +
  geom_histogram(bins = 10) # Most positions are 0-3 hours

# Number of dives using different time thresholds 
time_thresh <- seq(0.75, 2, 0.25)

possible_sites <- NULL

for(i in time_thresh){
  
  possible_sites <- possible_sites %>% 
    bind_rows(binned_locations %>% 
                mutate(time_threshold = i) %>% 
                mutate(dive = ifelse(total_hours >= time_threshold, 1, 0)))
}

# Total time > 12 hours might just be an overnight stop and not a dive site
possible_sites <- possible_sites %>% 
  mutate(overnight = ifelse(total_hours > 12, 'yes', 'no'))

# Number of dives in each grid cell 
compare_dives <- possible_sites %>% 
  filter(overnight == 'no') %>% 
  group_by(lat_bin, lon_bin, time_threshold) %>% 
  dplyr::summarize(dives = sum(dive))

# Totals by threshold (not including overnight stops)
compare_totals <- compare_dives %>% 
  mutate(has_dives = ifelse(dives > 0 , 'yes', 'no')) %>% 
  filter(has_dives == 'yes') %>% 
  group_by(time_threshold) %>% 
  dplyr::summarize(n_cells = n()) %>% 
  mutate(diff_cells = c(0, diff(n_cells)))

ggplot(compare_totals) + 
  geom_col(aes(x=time_threshold, y=n_cells)) + 
  labs(x='Time Cutoff',
       y="Number of unique grid cells with 'dives'") + 
  scale_x_continuous(expand = c(0,0),
                     breaks = seq(0.75,2,0.25)) + 
  scale_y_continuous(expand = c(0,0)) +
  theme_bw()
```
## Compare Sites 

For each of the identified time thresholds above, count the number of dives sites if a dive site is considered as a grid cell where more than 10, 20, 30, 40, or 50 vessels moving under 1 knot stop for at least the threshold amount of time  

```{r compare-sites}
# Number of dives to be considered a dive site
site_threshold <- seq(5,25,5)

compare_sites  <- NULL

for(i in site_threshold){
  
  compare_sites <- compare_sites %>% 
    bind_rows(compare_dives %>% 
                mutate(site_threshold = i) %>% 
                mutate(dive_site = ifelse(dives >= site_threshold, 1, 0)))
}

# Removes ones that are never dive sites
compare_sites <- compare_sites %>% 
  group_by(lat_bin, lon_bin) %>% 
  mutate(totals = sum(dive_site)) %>% 
  ungroup() %>% 
  filter(totals > 0) %>% 
  dplyr::select(-totals)

# Dive sites by time threshold 
sites_by_threshold <- compare_sites %>% 
  group_by(time_threshold, site_threshold) %>% 
  summarize(n_sites = sum(dive_site)) %>% 
  ungroup() %>% 
  mutate(time_threshold = factor(time_threshold)) 


ggplot(data = sites_by_threshold) + 
  geom_col(aes(x= site_threshold, y = n_sites, fill = time_threshold),
           position = 'dodge') +
  scale_fill_manual(values = paletteer::paletteer_d("nationalparkcolors::ArcticGates", n=6)) + 
  labs(x="Site treshold (minimum number of 'dives'per year)",
       y="Number of dive sites",
       fill = "Time threshold") + 
  scale_x_continuous(expand = c(0,0),
                     breaks = seq(5,25,5)) + 
  scale_y_continuous(expand = c(0,0)) +
  theme_bw() # Do we have any sense of how many dive sites there are in the channel islands? 
```
Mapping what dive sites are added as the time spent in a location decreases.   
```{r map-dive-sites}
# Load CI shp 
ci_shp <- st_read(file.path(project_data_path, "processed", "spatial", "channel_islands.shp"))

## Central CA counties 
ca_counties <- tigris::counties() %>% 
  filter(GEOID %in% c('06083', '06111', '06037'))

# First just look at a 5 vessel per year cutoff 
for(i in site_threshold){
  
  site_cutoff <- compare_sites %>% 
    filter(site_threshold == i,
           dive_site == 1) %>% 
    mutate(time_threshold = factor(time_threshold))
  
  maxi <- max(sites_by_threshold$n_sites[sites_by_threshold$site_threshold == i])
  mini <- min(sites_by_threshold$n_sites[sites_by_threshold$site_threshold == i])
  
  site_map <- ggplot() + 
    geom_sf(data = ca_counties, fill = NA) + 
    geom_sf(data = ci_shp, fill = NA) + 
    geom_point(data = site_cutoff,
               aes(x=lon_bin, y=lat_bin, color=time_threshold)) + 
    scale_color_manual(values = paletteer::paletteer_d("nationalparkcolors::ArcticGates", n=6)) + 
    labs(x="",
         y="",
         title = paste0("Site Threshold: ", i, " vessels per year"),
         color = "Time Threshold",
         subtitle = paste0("Max dive sites: ", maxi, "; Min dive sites: ", mini)) + 
    theme_bw()
  
  return(site_map)
}



```


## OLD 
```{r}
library(tigris)
library(kableExtra)

# Load CI shp 
ci_shp <- st_read(file.path(project_data_path, "processed", "spatial", "channel_islands.shp"))

# Load US counties shp 
us_counties <- tigris::counties()

## Central CA counties 
ca_counties <- us_counties %>% 
  filter(GEOID %in% c('06083', '06111', '06037'))
```

# Check Existing Anchorages 

Check for any GFW anchorages near the Channel Islands, this may represent dive sites.

```{r query-anchorages}
sql_anchorages <- "#StandardSQL

  SELECT 
    *
  FROM 
    `world-fishing-827.anchorages.named_anchorages_v20211026` 
  WHERE (lon >= -121 AND lon <= -118)
  AND (lat >= 32.5 AND lat <= 34.5)"

anchorages <- bq_project_query("emlab-gcp",
                               sql_anchorages) %>% 
  bq_table_download(n_max = Inf)
```

Plot the results of the anchorages query over the central California counties and channel islands boundaries. It is likely that there will be anchorages for ports in Santa Barbara, Ventura, and LA included in these initial results. 
```{r map-anchorages}
ggplot() + 
  geom_sf(data = ca_counties, fill = NA) + 
  geom_sf(data = ci_shp, fill = NA) + 
  geom_point(data = anchorages, aes(x=lon, y=lat, color = label), alpha = 0.6)
```

The map shows some overlap of anchorages in ports along the coast but there are also some that are associated with the islands. We need to narrow down these results for just the anchorages being shown near the islands. It looks like the following are labels of interest: Anacapa Isl, Avalon, AZ A, BF, Btai, Catalina Is, Isthmus Cove, Prisoners, San Diego, San Miguel Is, Santa Barbara Island, Santa Catalina Is, Santa Cruz Island, Santa Rosa Is, SantaBarbara, Scorpion Anch, Whites Cove Catalina, and Wilson Cove 

```{r}
island_anchorages <- anchorages %>% 
  filter(label %in% c('ANACAPA ISL', 'AVALON', 'AZ A', 'BF', 'BTAI', 'CATALINA IS',
                      'ISTHMUS COVE', 'PRISONERS', 'SAN DIEGO', 'SAN MIGUEL IS',
                      'SANTA BARBARA ISLAND', 'SANTA CATALINA IS', 'SANTA CRUZ ISLAND',
                      'SANTA ROSA IS', 'SANTABARBARA', 'SCORPION ANCH', 'WHITES COVE CATALINA',
                      'WILSON COVE')) %>% 
  # 3 anchorages labeled 'San Deigo', 2 in SB county and one on San Clemente (keep)
  filter(s2id != '80e8f09d' & s2id != '80eea361')

# Check on map 
ggplot() + 
  geom_sf(data = ca_counties, fill = NA) + 
  geom_sf(data = ci_shp, fill = NA) + 
  geom_point(data = island_anchorages, aes(x=lon, y=lat, color = label), alpha = 0.6) # Good 


# Clean up anchorages dataset 
island_anchorages_clean <- island_anchorages %>% 
  # 2 anchorages on Santa Cruz mislabeled with Catalina labels
  mutate(label = ifelse(s2id == '80e8fa5b' | s2id == '80e8fa45', 'SANTA CRUZ ISLAND', label)) %>% 
  mutate(anchorage_island = case_when(label == 'SANTA BARBARA ISLAND' ~ "Santa Barbara",
                                      label == 'SANTA ROSA IS' ~ "Santa Rosa",
                                      label == 'SAN MIGUEL IS' ~ "San Miguel",
                                      label == 'ANACAPA ISL' ~ "Anacapa",
                                      label == 'SAN DIEGO' | label == 'WILSON COVE' ~ "San Clemente",
                                      label == 'AVALON' | label == 'CATALINA IS' | 
                                        label == 'SANTA CATALINA IS' | label == 'WHITES COVE CATALINA' |
                                        label == 'ISTHMUS COVE' ~ "Catalina",
                                      TRUE ~ 'Santa Cruz')) %>% 
  dplyr::select(lat, lon, anchorage_id = s2id, anchorage_gfw_label = label, anchorage_island,
                total_visits, unique_stationary_ssvid, unique_stationary_fishing_ssvid, 
                unique_active_ssvid, unique_total_ssvid)

# Summarize anchorages by island 
anch_by_island <- island_anchorages_clean %>% 
  group_by(anchorage_island) %>% 
  summarize(n_anchorages_gfw = n()) %>% 
  adorn_totals('row')

kable(anch_by_island,
      col.names = c("Island", "Number of Anchorages"),
      caption = "Number of anchorages found in GFW by island.") %>% 
  kable_classic_2()
```

```{r map-by-island}
# Check on map 
ggplot() + 
  geom_sf(data = ca_counties, fill = NA) + 
  geom_sf(data = ci_shp, fill = NA) + 
  geom_point(data = island_anchorages_clean, aes(x=lon, y=lat, color = anchorage_island), alpha = 0.6) +
  labs(x = "",
       y = "",
       color = 'Island') + 
  theme_bw() # Good 
```
Main ports by Island: 

 - San Miguel: Cuyler Harbor  
 - Santa Rosa: Bechers Bay  
 - Santa Cruz: Prisoners Harbor and Scorpion  
 - Anacapa: East End Landing Cove  
 - Santa Barbara: Landing Cove  
 - Catalina: Two Harbors and Avalon  
 - San Clemente: Wilson Cove and Pyramid Cove  