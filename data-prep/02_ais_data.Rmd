---
title: "Vessel Tracks"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r libraries, include=F}
# Load libraries
library(tidyverse)
library(glue)
library(stringr)
library(sf)
library(paletteer)
library(grDevices)
library(colorspace)
library(bigrquery)
library(DBI)

# Load source
source(file.path(here::here(),"common.R"))
```

# Bounding Box 

```{r check-bbox}
# Central CA coastline
ca_counties <- tigris::counties() %>% 
  filter(GEOID %in% c('06083', '06111', '06037'))

# CI polygons
ci_polys <- st_read(file.path(project_data_path, "processed", "spatial", "channel_islands.shp"))

# bbox coords xmin: -121, xmax: -118; ymin: 32.5, ymax: 34.5
bbox_coords <- matrix(c(-121, 32.5,
                        -118, 32.5,
                        -118, 34.5,
                        -121, 34.5,
                        -121, 32.5),
                        ncol = 2, byrow = TRUE)

bbox_poly <-st_polygon(list(bbox_coords))
bbox_poly <- st_sfc(bbox_poly)
st_crs(bbox_poly) <- 4326

ggplot() + 
  geom_sf(data = ca_counties) +
  geom_sf(data = ci_polys) +
  geom_sf(data = bbox_poly, color = 'midnightblue',
          fill = NA)
```

# Query AIS Data 2021

For now just query all AIS data for 2021 for the area around the Channel Islands for all ssvids (11) on the AIS vessel list. 

Bounding box: 
  xmin: -121, xmax: -118
  ymin: 32.5, ymax: 34.5

```{r}
# Run in BQ console b/c of the create or replace statement
# Query is very large 3Tb 
# Saved as emlab-gcp.boi_dive_project.ci_ais_activity_2021
sql_ais <- "#StandardSQL

CREATE OR REPLACE TABLE
  emlab-gcp.boi_dive_project.ci_ais_activity_2021
  PARTITION BY date
  CLUSTER BY ssvid
  AS

WITH 

good_segments AS (
  SELECT
    seg_id
  FROM
    `world-fishing-827.pipe_production_v20201001.research_segs`
  WHERE good_seg
  AND positions > 10
  AND NOT overlapping_and_short
),

ais AS (
 SELECT
   *,
   EXTRACT(DATE FROM timestamp) AS date
 FROM
  `world-fishing-827.pipe_production_v20201001.research_messages`
 WHERE
   seg_id IN (
     SELECT
       seg_id
      FROM
        good_segments
   )
  AND _PARTITIONTIME BETWEEN '2021-01-01' AND '2021-12-31'
  AND (lon >= -121 AND lon <= -118)
  AND (lat >= 32.5 AND lat <= 34.5)
  AND ssvid IN (
    SELECT
      SAFE_CAST(ssvid AS STRING) AS ssvid
    FROM
      `emlab-gcp.boi_dive_project.ais_vessel_list`
  )
)

SELECT * FROM ais"
```

## Visualize AIS Data

Visualize where vessels are moving throughout the Channel Islands and how long vessels are spending at different locations.  

### Tracks

```{r}
# Run and download 
tracks <- bq_table_download('emlab-gcp.boi_dive_project.ci_ais_activity_2021',
                            n_max = Inf) %>% 
  dplyr::select(ssvid, timestamp, lat, lon, hours, date)

# Save 
write_csv(tracks, file.path(project_data_path, "processed", "ais_tracks_2021.csv"))
```

```{r tracks}
# Start by looking at SB, Ventura, and Oxnard dive operators
ais_list <- read_csv(file.path(project_data_path, "processed", "ais_vessel_list.csv"))
vessels <- ais_list %>% 
  filter(ca_area %in% c('Santa Barbara', 'Ventura', 'Oxnard')) # 7 vessels

# Read-in tracks
tracks <- read_csv(file.path(project_data_path, "processed", "ais_tracks_2021.csv"))

# Filter for just the SB, Ventura, Oxnard vessels
tracks_filter <- tracks %>% 
  filter(ssvid %in% vessels$ssvid) %>% 
  arrange(timestamp)

# Create labels for legend 
pal_labels <- vessels %>% 
  mutate(label = paste0(ssvid, ": ", str_to_sentence(n_shipname))) %>% 
  arrange(label) %>% 
  .$label

# Colors: Everglades pal + purple from Redwoods (National park colors) 
track_pal <- c('#91D5DEFF', '#2E8289FF', '#B4674EFF', '#EAAE37FF', '#565F41FF', '#6E687EFF')

# Plot vessel tracks (all)
track_plot <- ggplot() + 
  geom_sf(data = ca_counties) + 
  geom_sf(data = ci_polys) + 
  geom_point(data = tracks_filter,
             aes(x = lon, 
                 y = lat,
                 color = ssvid),
             alpha = 0.4) + 
  geom_path(data = tracks_filter,
            aes(x = lon, 
                y = lat,
                color = ssvid), 
            alpha = 0.8) + 
  scale_color_manual(values = track_pal,
                     labels = pal_labels) + 
  labs(title = "Dive Boat Vessel Tracks",
       subtitle = "January 1, 2021 - December 31, 2021",
       color = "") + 
  theme_bw() + 
  theme(axis.line = element_blank(), 
        axis.text = element_blank(),
        axis.ticks = element_blank(), 
        axis.title = element_blank(),
        panel.background = element_blank())
```

```{r save-figure}
ggsave(plot = track_plot,
       filename = file.path(project_figure_path, "dive_vessel_track_map_2021.png"),
       dpi = 300)
```

