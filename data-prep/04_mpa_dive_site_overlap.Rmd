---
title: 'Dive Site MPA Overlap'
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    number_sections: false
    self_contained: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r libraries, include=F}
# Load libraries
library(tidyverse)
library(sf)
library(bigrquery)
library(lubridate)
library(paletteer)

# Load source
source(file.path(here::here(),"common.R"))

# Dive sites
dive_sites <- read_csv(file.path(project_data_path, "processed", "dive_sites_1hr_1vessel.csv"))

# Vessel info 
vessel_info <- read_csv(file.path(project_data_path, "processed", "ais_vessel_list.csv"))
```

```{r mapping, include=F}
# CA counties
ca_counties <- tigris::counties() %>% 
  filter(GEOID %in% c('06083', '06111', '06037', '06059', '06073'))

# Channel Islands shp
ci_shp <- st_read(file.path(project_data_path, "processed", "spatial", "channel_islands.shp"))

# MPA Boundaries 
mpa_shp <- st_read(file.path(project_data_path, "processed", "spatial", "channel_islands_mpas.shp"))
```

## Overview 

In this document we look at the overlap of dive sites and MPAs. We are counting a dive site as any grid cell with at least 1 visits, where a visit is defined as a dive boat that has remained stationary in that grid cell for at least 1 hours on a given day. We first filter AIS positions for only those occurring during the day and we define stationary as any position where the vessel moves slower than 1 knot.   

The following steps are used to quantify dive site and MPA overlap:   

  - Buffer MPAS: create a 500 meter buffer around each MPA site 
  - Classify Dive Sites: categorize each dive site as being within a MPA, within a buffer, or outside a MPA  
  - Count Dives: Look at all AIS positions during the day where vessels move slower than 1 knot, count a "dive" as any time the vessel remains stationary in one of the identified dive site grid cells for at least 1 hour.  
  - Compare MPA Dives: determine the number of dives within MPAs, within MPA buffers, and outside of MPAs  

## Buffer MPAs

Map of Channel Islands MPAs based on the 2020 MPA Atlas. For determining if dive sites are within an MPA, we look at just MPAs that are fully no take (24 of the 33 MPA areas). The following areas are considered fully no take: 

  - State Marine Reserves (all 13)  
  - State Marine Conservation Areas (2 of 10; both on Catalina Island)  
  - Federal Marine Reserve (all 8)  
  - Federal Marine Conservation Area (1 of 1; Anacapa Island)  

```{r mpa-map}
# Separate by no take designation 
mpa_other <- mpa_shp %>% 
  filter(no_take != 'All') %>% 
  mutate(no_take = 'None/Not Reported')

mpa_all <- mpa_shp %>% 
  filter(no_take == 'All')

ggplot() + 
  geom_sf(data = ci_shp, fill = NA, color = 'black') + 
  geom_sf(data = mpa_other, aes(fill = no_take), alpha = 0.4) + 
  geom_sf(data = mpa_all, aes(fill = no_take), alpha = 0.6) + 
  scale_fill_manual(breaks = c('All', 'None/Not Reported'),
                    values = c('forestgreen', 'goldenrod')) + 
  labs(fill = "No Take Designation",
       x="",
       y="") + 
  theme_bw()
```

```{r buffer-mpas, include=F}
# Create 500 meter buffer around no take MPA boundaries
mpa_buff <- st_buffer(mpa_all, dist=500)

# Remove the polygon to just get the buffer
mpa_buff_boundary  <- rmapshaper::ms_erase(mpa_buff, mpa_all)
```

## Classify Dive Sites

We classify each of the 3,199 dive sites as being within a MPA, within a buffer, or outside a MPA. The graph shows the fraction of dive sites within each category. Dive sites are also mapped relative to MPAs which are colored by their no take designation in the MPA Atlas.   

```{r classify-dive-sites, echo=F}
# Crs of mpa shp 
target_crs <- st_crs(mpa_all)

# Create spatial points from dive sites
dive_sites_sf <- st_as_sf(dive_sites,
                          coords = c('lon_bin', 'lat_bin'),
                          crs = target_crs)

# Dive sites within the MPA boundary 
sites_in_mpa <- st_intersection(dive_sites_sf, mpa_all) #379 unique sites 

# Dive sites within the buffer 
sites_in_buffer <- st_intersection(dive_sites_sf, mpa_buff_boundary) #249 unique sites

# Combine 
dive_site_categories <- sites_in_mpa %>% 
  mutate(site_category = "in_mpa") %>% 
  bind_rows(sites_in_buffer %>% 
              mutate(site_category = "in_buffer"))

# What sites aren't in MPAs or the buffer?
ids <- dive_site_categories$site_id

missing_ids <- setdiff(dive_sites$site_id, ids) #2,571 outside 

outside <- dive_sites_sf %>% 
  filter(site_id %in% missing_ids) %>% 
  mutate(site_category = 'outside_mpa')

# Add missing to the list 
all_site_categories <- dive_site_categories %>% 
  dplyr::select(site_id, site_type, site_category, mpa_id, name, mpa_type, mpa_year = status_yr) %>% 
  bind_rows(outside) %>% 
  arrange(site_id)

## Save dive sites by category
dive_site_categories_save <- all_site_categories %>% st_set_geometry(NULL)
#write_csv(dive_site_categories_save, file.path(project_data_path, "processed", "dive_sites_by_mpa_category.csv"))

# Plot dive sites by category
sites_by_cat <- all_site_categories %>% 
  st_set_geometry(NULL) %>% 
  dplyr::select(site_id, site_category) %>% 
  distinct() %>% 
  group_by(site_category) %>% 
  summarize(n_dive_sites = n()) %>% 
  ungroup() %>% 
  mutate(total_sites = nrow(dive_sites)) %>% 
  mutate(frac_sites = round(n_dive_sites / total_sites, 2))

ggplot(sites_by_cat) + 
  geom_col(aes(x=site_category, y=n_dive_sites),
           fill = 'slategrey',
           alpha = 0.95) + 
  geom_text(aes(label = frac_sites, x = site_category, y = n_dive_sites + 0.5),
            position = position_dodge(0.9),
            vjust = 0) + 
  scale_x_discrete(expand = c(0,0),
                   breaks = c("in_buffer", "in_mpa", "outside_mpa"),
                   labels = c("In Buffer", "In MPA", "Outside MPA")) + 
  scale_y_continuous(expand = c(0,0),
                     limits = c(0,2800),
                     breaks = seq(0,2500,500)) +
  labs(y = 'Number of Dive Sites',
       x = 'Dive Site Category') + 
  theme_bw()
```
<br>  

```{r dive-site-map, echo=F}
ggplot() + 
  geom_sf(data = ci_shp, fill = NA, color = 'black') + 
  geom_sf(data = mpa_other, aes(fill = no_take), alpha = 0.4) + 
  geom_sf(data = mpa_all, aes(fill = no_take), alpha = 0.6) + 
  geom_sf(data = dive_sites_sf,
          color = 'midnightblue',
          alpha = 0.8) + 
  scale_fill_manual(breaks = c('All', 'None/Not Reported'),
                    values = c('forestgreen', 'goldenrod')) + 
  labs(x="",
       y="",
       fill = "No Take Designation") + 
  theme_bw() + 
  theme(axis.ticks = element_blank(),
        axis.text = element_blank())
```

## Count Dives {.tabset}

```{r sql-ais-positions, include=F, eval=F}
# Keeping only coordinates where night = FALSE and vessels moved slower than 1 knot 2016-2021
sql_ais_locations <- "#StandardSQL

SELECT
  ssvid,
  date,
  lat_bin,
  lon_bin,
  SUM(hours) AS total_hours
FROM (
  SELECT
    ssvid,
    date,
    FLOOR(lat * 1000) / 1000 + 0.0005 AS lat_bin,
    FLOOR(lon * 1000) / 1000 + 0.0005 AS lon_bin,
    hours
  FROM
    `emlab-gcp.boi_dive_project.ci_ais_activity_all_years`
  WHERE speed_knots < 1
  AND NOT night
  AND EXTRACT(year FROM date) >= 2016
  AND EXTRACT(year FROM date) <= 2021
)
GROUP BY ssvid, date, lat_bin, lon_bin"

# Run and download 
ais_locations <- bq_project_query("emlab-gcp", sql_ais_locations) %>% 
  bq_table_download(n_max = Inf)

# Save so this doesn't have to be re-run
#write_csv(ais_locations, file.path(project_data_path, "processed", "ais_stationary_day_positions_2016_2021.csv"))
```

We count dives from AIS positions using only positions during the day where vessels are moving slower than 1 knot and remain stationary within an identified "dive site" cell for at least 1 hour. 

### Dives by Year

The total number of dives by year aggregated across all vessels is shown in the first plot and the number of dives by year for each vessel is shown in the second plot. We see an (expected) decline in dive activity from 2019-2020. This plot is reflective of dives from only those vessels who have responded to the survey so far: Spectre, Peace, Raptor, and Vision.         

```{r count-dives, include=F}
ais_positions <- read_csv(file.path(project_data_path, "processed", "ais_stationary_day_positions_2016_2021.csv"))

# Filter positions where hours > 1
# Join to dive site locations
ais_dives <- ais_positions %>% 
  filter(total_hours >= 1) %>% 
  inner_join(dive_sites, by = c("lat_bin", "lon_bin")) %>% 
  left_join(vessel_info %>% 
              dplyr::select(ssvid, shipname),
            by = "ssvid") %>% 
  filter(shipname %in% c("Spectre", "Peace", "Raptor", "Vision"))

## Join to MPA info 
# Join site locations to MPA category
ais_mpa_dives <- ais_dives %>% 
  left_join(all_site_categories, by = "site_id") 
```

```{r dives-year}
# Dives per year (not by MPA)
dives_per_year <- ais_dives %>% 
  mutate(year = lubridate::year(date)) %>% 
  group_by(year) %>% 
  summarize(n_dives = n()) %>% 
  ungroup()

ggplot(dives_per_year) + 
  geom_col(aes(x=year, y=n_dives),
           fill = 'slategrey',
           alpha = 0.95) + 
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_continuous(expand = c(0,0),
                     limits = c(0,1200),
                     breaks = seq(0,1200,300)) +
  labs(y = 'Number of Dives (all vessels)',
       x = 'Year') + 
  theme_bw()
```

<br>  

For now, we're just looking at the four vessels who have responded to the survey: Spectre, Peace, Raptor, and Vision. 

```{r dives-vessel-year, echo=F}
# Dives per vessel per year (not by MPA)
dives_per_vessel_year <- ais_dives %>% 
  mutate(year = lubridate::year(date)) %>% 
  group_by(ssvid, year) %>% 
  summarize(n_dives = n()) %>% 
  ungroup()

ggplot(dives_per_vessel_year) +
  geom_point(aes(x=year, y=n_dives, color=shipname)) + 
  geom_line(aes(x=year, y=n_dives, color=shipname, group=shipname)) + 
  scale_x_continuous(expand = c(0.01,0.01)) + 
  scale_y_continuous(expand = c(0.01,0),
                     limits = c(1,400),
                     breaks = seq(0,400,100)) + 
  labs(x = "Year", 
       y = "Number of Dives",
       color = "Shipname") + 
  theme_bw()
```

### Sites by Year

The number of unique dive sites visited each year on the whole was increasing slightly each year, with a noticeable decline from 2019-2020 and continues to increase from 2020 to 2021. These numbers are reflective of all vessels, while the by vessel and year will look at only those vessels who have responded to the survey so far: Spectre, Peace, Raptor, and Vision.   
<br>  

```{r unique-sites-per-year, echo=F}
# Unique sites visited per year 
sites_per_year <- ais_dives %>% 
  mutate(year = lubridate::year(date)) %>% 
  dplyr::select(year, site_id) %>% 
  distinct() %>% 
  group_by(year) %>% 
  summarize(n_unique_sites = n()) %>% 
  ungroup() 

ggplot(sites_per_year) + 
  geom_col(aes(x=year, y=n_unique_sites),
           fill = 'slategrey',
           alpha = 0.95) + 
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_continuous(expand = c(0,0),
                     limits = c(0,570),
                     breaks = seq(0,550,50)) +
  labs(y = 'Number of Unique Dive Sites',
       x = 'Year') + 
  theme_bw()
```
<br> 

```{r unique-sites-per-vessel-year, echo=F}
# Unique sites visited by each vessel in a year 
sites_per_vessel_year <- ais_dives %>% 
  mutate(year = lubridate::year(date)) %>% 
  dplyr::select(ssvid, year, site_id) %>% 
  distinct() %>% 
  group_by(ssvid, year) %>% 
  summarize(n_unique_sites = n()) %>% 
  ungroup()

ggplot(sites_per_vessel_year) +
  geom_point(aes(x=year, y=n_unique_sites, color=shipname)) + 
  geom_line(aes(x=year, y=n_unique_sites, color=shipname, group=shipname)) + 
  scale_x_continuous(expand = c(0.01,0.01)) + 
  scale_y_continuous(expand = c(0.01,0),
                     limits = c(0,275),
                     breaks = seq(0,250,50)) + 
  labs(x = "Year", 
       y = "Number of Unique Sites Visited",
       color = "Shipname") + 
  theme_bw()
```

## Compare Dives {.tabset}

### Aggregate 

The first plot shows the proportion of total dives by all vessels within each of the site classifications. Again, this is just looking at the four vessels which have responded to the survey so far. On the whole, this indicates that roughly twice as many dives happen outside of MPAs than inside MPAs and MPA buffers. But there are also many more dive sites identified outside of MPAs.  

```{r overall-dives-by-category, echo=F}
# Overall fraction of dives by category 
dive_summary <- ais_mpa_dives %>% 
  dplyr::select(ssvid, date, site_id, site_category) %>% 
  distinct() %>% # Remove any dives classified as being at two MPAs 
  group_by(site_category) %>%
  summarize(n_total_dives = n()) %>% 
  ungroup()

annual_dive_summary <- ais_mpa_dives %>% 
  dplyr::select(ssvid, date, site_id, site_category) %>% 
  mutate(year = lubridate::year(date)) %>% 
  group_by(year) %>% 
  mutate(n_total_dives = n()) %>% 
  ungroup() %>% 
  group_by(year, n_total_dives, site_category) %>%
  summarize(n_dives = n()) %>% 
  ungroup() %>% 
  mutate(frac_dives = n_dives / n_total_dives)

ggplot(annual_dive_summary) + 
  geom_col(aes(x=year, y=frac_dives, fill=site_category)) + 
  scale_fill_manual(values = c("#F4E7C5FF", "#979461FF", "#CD5733FF"),
                    labels = c("In Buffer", "In MPA", "Outside MPA")) + 
  scale_x_continuous(expand = c(0,0),
                     breaks = seq(2016,2021,1)) + 
  scale_y_continuous(expand = c(0,0)) +
  labs(y = 'Proportion of Dives',
       x = 'Year',
       fill = 'Dive Site\nCategory') + 
  theme_bw()
```

### By Vessel

The next three graphs show the breakdown of dives by site category for each vessel. The first two are aggregated as total dives from 2016-2021 displayed both as a relative proportion and as an absolute number. Two of the vessels seem to dive about 50/50 inside and outside MPAs while the other two are predominantly diving outside of MPAs. 

The final graph is the breakdown of sites by category for each vessel in each year. 

```{r prop-vessel-dives-by-category, echo=F}
# Fraction of dives by category and vessel
dives_by_category <- ais_mpa_dives %>% 
  dplyr::select(ssvid, shipname, date, site_id, site_category) %>% 
  distinct() %>% # Remove any dives classified as being at two MPAs 
  group_by(ssvid, shipname) %>% 
  mutate(n_total_dives = n()) %>% 
  ungroup() %>% 
  group_by(ssvid, shipname, n_total_dives, site_category) %>%
  summarize(n_dives = n()) %>% 
  ungroup() %>% 
  mutate(frac_of_total = n_dives / n_total_dives)

ggplot(dives_by_category) + 
  geom_col(aes(x=frac_of_total, y=fct_rev(factor(shipname)), fill = site_category)) +
  scale_y_discrete(expand = c(0,0)) + 
  scale_x_continuous(expand = c(0,0)) + 
  scale_fill_manual(values = c("#F4E7C5FF", "#979461FF", "#CD5733FF"),
                    labels = c("In Buffer", "In MPA", "Outside MPA")) + 
  labs(y = "Shipname",
       x = "Proportion of Total Dives 2016-2021",
       fill = "Dive Site\nCategory") + 
  theme_bw()
```
<br> 
```{r vessel-dives-category, echo=F}
ggplot(dives_by_category) + 
  geom_col(aes(x=n_dives, y=fct_rev(factor(shipname)), fill = site_category)) +
  scale_y_discrete(expand = c(0,0)) + 
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,1800),
                     breaks = seq(0,1800,600)) + 
  scale_fill_manual(values = c("#F4E7C5FF", "#979461FF", "#CD5733FF"),
                    labels = c("In Buffer", "In MPA", "Outside MPA")) + 
  labs(y = "Shipname",
       x = "Total Dives 2016-2021",
       fill = "Dive Site\nCategory") + 
  theme_bw()
```
<br>  
```{r dives-category-overtime, echo=F}
# Dives by category per year
annual_dives_by_category <- ais_mpa_dives %>% 
  dplyr::select(ssvid, shipname, date, site_id, site_category) %>% 
  distinct() %>% # Remove any dives classified as being at two MPAs 
  mutate(year = lubridate::year(date)) %>% 
  group_by(ssvid, shipname, year) %>% 
  mutate(n_annual_dives = n()) %>% 
  ungroup() %>% 
  group_by(ssvid, shipname, year, n_annual_dives, site_category) %>%
  summarize(n_dives = n()) %>% 
  ungroup() %>% 
  mutate(frac_of_total = n_dives / n_annual_dives) 

ggplot(annual_dives_by_category) + 
  geom_col(aes(x=frac_of_total, y=fct_rev(factor(shipname)), fill = site_category)) +
  scale_y_discrete(expand = c(0,0)) + 
  scale_x_continuous(expand = c(0,0)) + 
  scale_fill_manual(values = c("#F4E7C5FF", "#979461FF", "#CD5733FF"),
                    labels = c("In Buffer", "In MPA", "Outside MPA")) + 
  labs(y = "Shipname",
       x = "Proportion of Total Dives 2016-2021",
       fill = "Dive Site\nCategory") + 
  theme_bw() + 
  facet_wrap(~year)
```

