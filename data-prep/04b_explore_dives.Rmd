---
title: "Explore Dives"
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    number_sections: false
    self_contained: true
---

### Dives by Year

The total number of dives by year aggregated across all vessels is shown in the first plot and the number of dives by year for each vessel is shown in the second plot. We see an (expected) decline in dive activity from 2019-2020. This plot is reflective of dives from only those vessels who have responded to the survey so far: Spectre, Peace, Raptor, and Vision.         

```{r count-dives, include=F}
ais_positions <- read_csv(file.path(project_data_path, "processed", "ais_stationary_day_positions_2016_2021.csv"))

# Filter positions where hours > 1
# Join to dive site locations
ais_dives <- ais_positions %>% 
  filter(total_hours >= 1) %>% 
  inner_join(dive_sites, by = c("lat_bin", "lon_bin")) %>% 
  left_join(vessel_info %>% 
              dplyr::select(ssvid, shipname),
            by = "ssvid") %>% 
  filter(shipname %in% c("Spectre", "Peace", "Raptor", "Vision"))

## Join to MPA info 
# Join site locations to MPA category
ais_mpa_dives <- ais_dives %>% 
  left_join(all_site_categories, by = "site_id") 
```

```{r dives-year}
# Dives per year (not by MPA)
dives_per_year <- ais_dives %>% 
  mutate(year = lubridate::year(date)) %>% 
  group_by(year) %>% 
  summarize(n_dives = n()) %>% 
  ungroup()

ggplot(dives_per_year) + 
  geom_col(aes(x=year, y=n_dives),
           fill = 'slategrey',
           alpha = 0.95) + 
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_continuous(expand = c(0,0),
                     limits = c(0,1200),
                     breaks = seq(0,1200,300)) +
  labs(y = 'Number of Dives (all vessels)',
       x = 'Year') + 
  theme_bw()
```

<br>  

For now, we're just looking at the four vessels who have responded to the survey: Spectre, Peace, Raptor, and Vision. 

```{r dives-vessel-year, echo=F}
# Dives per vessel per year (not by MPA)
dives_per_vessel_year <- ais_dives %>% 
  mutate(year = lubridate::year(date)) %>% 
  group_by(ssvid, shipname, year) %>% 
  summarize(n_dives = n()) %>% 
  ungroup()

ggplot(dives_per_vessel_year) +
  geom_point(aes(x=year, y=n_dives, color=shipname)) + 
  geom_line(aes(x=year, y=n_dives, color=shipname, group=shipname)) + 
  scale_color_manual(values = paletteer::paletteer_d("nationalparkcolors::ArcticGates", n=4)) + 
  scale_x_continuous(expand = c(0.01,0.01)) + 
  scale_y_continuous(expand = c(0.01,0),
                     limits = c(1,400),
                     breaks = seq(0,400,100)) + 
  labs(x = "Year", 
       y = "Number of Dives",
       color = "Shipname") + 
  theme_bw()
```

### Sites by Year

The number of unique dive sites visited each year on the whole was increasing slightly each year, with a noticeable decline from 2019-2020 and continues to increase from 2020 to 2021. These numbers are reflective of only those vessels who have responded to the survey so far: Spectre, Peace, Raptor, and Vision.   
<br>  

```{r unique-sites-per-year, echo=F}
# Unique sites visited per year 
sites_per_year <- ais_dives %>% 
  mutate(year = lubridate::year(date)) %>% 
  dplyr::select(year, site_id) %>% 
  distinct() %>% 
  group_by(year) %>% 
  summarize(n_unique_sites = n()) %>% 
  ungroup() 

ggplot(sites_per_year) + 
  geom_col(aes(x=year, y=n_unique_sites),
           fill = 'slategrey',
           alpha = 0.95) + 
  scale_x_continuous(expand = c(0,0)) + 
  scale_y_continuous(expand = c(0,0),
                     limits = c(0,570),
                     breaks = seq(0,550,50)) +
  labs(y = 'Number of Unique Dive Sites',
       x = 'Year') + 
  theme_bw()
```
<br> 

The number of unique sites visited by each vessels seems to be generally in line with survey results, although the Vision reported visiting as many as 500 dive sites per year and that doesn't seem to be reflected in these numbers  
<br>  
```{r unique-sites-per-vessel-year, echo=F}
# Unique sites visited by each vessel in a year 
sites_per_vessel_year <- ais_dives %>% 
  mutate(year = lubridate::year(date)) %>% 
  dplyr::select(ssvid, shipname, year, site_id) %>% 
  distinct() %>% 
  group_by(ssvid, shipname, year) %>% 
  summarize(n_unique_sites = n()) %>% 
  ungroup()

ggplot(sites_per_vessel_year) +
  geom_point(aes(x=year, y=n_unique_sites, color=shipname)) + 
  geom_line(aes(x=year, y=n_unique_sites, color=shipname, group=shipname)) + 
  scale_color_manual(values = paletteer::paletteer_d("nationalparkcolors::ArcticGates", n=4)) + 
  scale_x_continuous(expand = c(0.01,0.01)) + 
  scale_y_continuous(expand = c(0.01,0),
                     limits = c(0,275),
                     breaks = seq(0,250,50)) + 
  labs(x = "Year", 
       y = "Number of Unique Sites Visited",
       color = "Shipname") + 
  theme_bw()
```
<br>  
It looks like vessels are visiting anywhere from 60 to 260 unique dive sites every year. This method for classifying dive sites used a less strict categorization, so here's a rough breakdown of how frequently dive sites were visited. 

```{r site-freqency, echo=F}
unique_sites <- ais_dives %>% 
  dplyr::select(lat_bin, lon_bin) %>% 
  distinct() #1399 unique sites

site_freqency_vessel_year <- ais_dives %>% 
  mutate(year = lubridate::year(date)) %>% 
  group_by(ssvid, shipname, year, site_id) %>% 
  summarize(n_visits_to_site = n()) %>% 
  ungroup()

ggplot(site_freqency_vessel_year) + 
  geom_histogram(aes(x=n_visits_to_site), 
                 fill = 'slategrey',
                 binwidth=3, 
                 boundary = 0) + 
  scale_x_continuous(expand = c(0,0),
                     breaks = seq(0,33,3)) + 
  scale_y_continuous(expand = c(0,0),
                     limits = c(0,1000),
                     breaks = seq(0,1000,250)) + 
  labs(x = "Number of Dives per Site", 
       y = "Freqency") + 
  theme_bw() + 
  facet_wrap(~shipname)
```

Many of the vessels seem to visit the sites only 1-3 times per year. The fraction of sites visited exactly once per year for each vessel is shown in the plot below. The Peace and Vision in particular seem to visit sites only once per year. For the most part since the number of unique sites the vessels are visiting seems to line up pretty well with survey responses, this might not necessarily be wrong but we may want to consider an analysis that differentiates between sites visited once and sites visited repeatedly.     

```{r single-visit, echo=F}
one_visit <- site_freqency_vessel_year %>% 
  group_by(ssvid, shipname, year) %>% 
  mutate(total_dives = sum(n_visits_to_site)) %>% 
  ungroup() %>% 
  filter(n_visits_to_site == 1) %>% 
  group_by(ssvid, shipname, year, total_dives) %>% 
  summarize(n_dives_one_visit = n()) %>% 
  ungroup() %>% 
  mutate(frac_single_visit = n_dives_one_visit / total_dives)

ggplot(one_visit) + 
  geom_col(aes(x=year, y=frac_single_visit, fill=shipname),
           position = 'dodge') + 
  scale_fill_manual(values = paletteer::paletteer_d("nationalparkcolors::ArcticGates", n=4)) + 
  scale_x_continuous(expand = c(0,0),
                     breaks = seq(2016,2021,1)) + 
  scale_y_continuous(expand = c(0,0),
                     limits = c(0,1)) +
  labs(y = 'Proportion of Dives',
       x = 'Year',
       fill = 'Shipname') + 
  theme_bw()
```

A breakdown of those sites visited only once per year by site category is shown below.  

```{r single-visit-mpa-category, echo=F}
one_visit_mpa <- ais_mpa_dives %>% 
  mutate(year = lubridate::year(date)) %>% 
  group_by(ssvid, shipname, year, site_id, site_category) %>% 
  summarize(n_visits_to_site = n()) %>% 
  ungroup() %>% 
  filter(n_visits_to_site == 1) %>% 
  group_by(ssvid, shipname, year) %>% 
  mutate(n_sites_visited_once = n()) %>% 
  ungroup() %>% 
  group_by(ssvid, shipname, year, n_sites_visited_once, site_category) %>% 
  summarize(n_sites = n()) %>% 
  ungroup() %>% 
  mutate(prop_by_category = n_sites / n_sites_visited_once)

ggplot(one_visit_mpa) + 
  geom_col(aes(x=year, y=prop_by_category, fill=site_category)) + 
  scale_fill_manual(values = c("#F4E7C5FF", "#979461FF", "#CD5733FF"),
                    labels = c("In Buffer", "In MPA", "Outside MPA")) + 
  scale_x_continuous(expand = c(0,0),
                     breaks = seq(2016,2021,1)) + 
  scale_y_continuous(expand = c(0,0)) +
  labs(y = 'Proportion of Dives to a Site Once per Year',
       x = 'Year',
       fill = 'Site Category') + 
  theme_bw() + 
  facet_wrap(~shipname)
```

Lastly, let's check the relative breakdown by site category of the dive sites that are visited more than once per year. 

```{r repeat-visit-mpa-category}
repeat_visit_mpa <- ais_mpa_dives %>% 
  mutate(year = lubridate::year(date)) %>% 
  group_by(ssvid, shipname, year, site_id, site_category) %>% 
  summarize(n_visits_to_site = n()) %>% 
  ungroup() %>% 
  filter(n_visits_to_site > 1) %>% 
  group_by(ssvid, shipname, year) %>% 
  mutate(n_sites_repeated = n()) %>% 
  ungroup() %>% 
  group_by(ssvid, shipname, year, n_sites_repeated, site_category) %>% 
  summarize(n_sites = n()) %>% 
  ungroup() %>% 
  mutate(prop_by_category = n_sites / n_sites_repeated)

ggplot(repeat_visit_mpa) + 
  geom_col(aes(x=year, y=prop_by_category, fill=site_category)) + 
  scale_fill_manual(values = c("#F4E7C5FF", "#979461FF", "#CD5733FF"),
                    labels = c("In Buffer", "In MPA", "Outside MPA")) + 
  scale_x_continuous(expand = c(0,0),
                     breaks = seq(2016,2021,1)) + 
  scale_y_continuous(expand = c(0,0)) +
  labs(y = 'Proportion of Dives to a Site Once per Year',
       x = 'Year',
       fill = 'Site Category') + 
  theme_bw() + 
  facet_wrap(~shipname)
```

## Compare Dives {.tabset}

### Aggregate 

The first plot shows the proportion of total dives by all vessels within each of the site classifications. Again, this is just looking at the four vessels which have responded to the survey so far. On the whole, this indicates that roughly twice as many dives happen outside of MPAs than inside MPAs and MPA buffers. But there are also many more dive sites identified outside of MPAs.  

```{r overall-dives-by-category, echo=F}
# Overall fraction of dives by category 
dive_summary <- ais_mpa_dives %>% 
  dplyr::select(ssvid, date, site_id, site_category) %>% 
  distinct() %>% # Remove any dives classified as being at two MPAs 
  group_by(site_category) %>%
  summarize(n_total_dives = n()) %>% 
  ungroup()

annual_dive_summary <- ais_mpa_dives %>% 
  dplyr::select(ssvid, date, site_id, site_category) %>% 
  mutate(year = lubridate::year(date)) %>% 
  group_by(year) %>% 
  mutate(n_total_dives = n()) %>% 
  ungroup() %>% 
  group_by(year, n_total_dives, site_category) %>%
  summarize(n_dives = n()) %>% 
  ungroup() %>% 
  mutate(frac_dives = n_dives / n_total_dives)

ggplot(annual_dive_summary) + 
  geom_col(aes(x=year, y=frac_dives, fill=site_category)) + 
  scale_fill_manual(values = c("#F4E7C5FF", "#979461FF", "#CD5733FF"),
                    labels = c("In Buffer", "In MPA", "Outside MPA")) + 
  scale_x_continuous(expand = c(0,0),
                     breaks = seq(2016,2021,1)) + 
  scale_y_continuous(expand = c(0,0)) +
  labs(y = 'Proportion of Dives',
       x = 'Year',
       fill = 'Dive Site\nCategory') + 
  theme_bw()
```

### By Vessel

The next three graphs show the breakdown of dives by site category for each vessel. The first two are aggregated as total dives from 2016-2021 displayed both as a relative proportion and as an absolute number. Two of the vessels seem to dive about 50/50 inside and outside MPAs while the other two are predominantly diving outside of MPAs. 

The final graph is the breakdown of sites by category for each vessel in each year. 

```{r prop-vessel-dives-by-category, echo=F}
# Fraction of dives by category and vessel
dives_by_category <- ais_mpa_dives %>% 
  dplyr::select(ssvid, shipname, date, site_id, site_category) %>% 
  distinct() %>% # Remove any dives classified as being at two MPAs 
  group_by(ssvid, shipname) %>% 
  mutate(n_total_dives = n()) %>% 
  ungroup() %>% 
  group_by(ssvid, shipname, n_total_dives, site_category) %>%
  summarize(n_dives = n()) %>% 
  ungroup() %>% 
  mutate(frac_of_total = n_dives / n_total_dives)

ggplot(dives_by_category) + 
  geom_col(aes(x=frac_of_total, y=fct_rev(factor(shipname)), fill = site_category)) +
  scale_y_discrete(expand = c(0,0)) + 
  scale_x_continuous(expand = c(0,0)) + 
  scale_fill_manual(values = c("#F4E7C5FF", "#979461FF", "#CD5733FF"),
                    labels = c("In Buffer", "In MPA", "Outside MPA")) + 
  labs(y = "Shipname",
       x = "Proportion of Total Dives 2016-2021",
       fill = "Dive Site\nCategory") + 
  theme_bw()
```
<br> 
```{r vessel-dives-category, echo=F}
ggplot(dives_by_category) + 
  geom_col(aes(x=n_dives, y=fct_rev(factor(shipname)), fill = site_category)) +
  scale_y_discrete(expand = c(0,0)) + 
  scale_x_continuous(expand = c(0,0),
                     limits = c(0,1800),
                     breaks = seq(0,1800,600)) + 
  scale_fill_manual(values = c("#F4E7C5FF", "#979461FF", "#CD5733FF"),
                    labels = c("In Buffer", "In MPA", "Outside MPA")) + 
  labs(y = "Shipname",
       x = "Total Dives 2016-2021",
       fill = "Dive Site\nCategory") + 
  theme_bw()
```
<br>  
```{r dives-category-overtime, echo=F}
# Dives by category per year
annual_dives_by_category <- ais_mpa_dives %>% 
  dplyr::select(ssvid, shipname, date, site_id, site_category) %>% 
  distinct() %>% # Remove any dives classified as being at two MPAs 
  mutate(year = lubridate::year(date)) %>% 
  group_by(ssvid, shipname, year) %>% 
  mutate(n_annual_dives = n()) %>% 
  ungroup() %>% 
  group_by(ssvid, shipname, year, n_annual_dives, site_category) %>%
  summarize(n_dives = n()) %>% 
  ungroup() %>% 
  mutate(frac_of_total = n_dives / n_annual_dives) 

ggplot(annual_dives_by_category) + 
  geom_col(aes(x=frac_of_total, y=fct_rev(factor(shipname)), fill = site_category)) +
  scale_y_discrete(expand = c(0,0)) + 
  scale_x_continuous(expand = c(0,0)) + 
  scale_fill_manual(values = c("#F4E7C5FF", "#979461FF", "#CD5733FF"),
                    labels = c("In Buffer", "In MPA", "Outside MPA")) + 
  labs(y = "Shipname",
       x = "Proportion of Total Dives 2016-2021",
       fill = "Dive Site\nCategory") + 
  theme_bw() + 
  facet_wrap(~year)
```